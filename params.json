{"name":"Ccxmleventemitter","tagline":"Connects the CurrentCost [basestation] XML output with node.js EventEmitter.","body":"#CCXMLEventEmitter\r\n=================\r\n\r\n###Latest News on features and development of this module.\r\n[Can be found here] (https://github.com/TheDistractor/CCXMLEventEmitter/wiki/latestnews)\r\n\r\n####Request 2013-06-15\r\nI am looking for more cc128 xml output files. If you can supply any large xml output files with at least 8 days or more cummulative data collection, or any\r\nfiles with specific anomalies (like spikes), or new devices, like 'GasSmart' transmitters etc, please pass them on so I can use them for testing.\r\nps: you can now use CCXMLEventEmitter class to record (or re-record) your cc128 output, using the 'logfile' parameter.\r\n\r\n\r\n###Changelog ([Issue List](https://github.com/TheDistractor/CCXMLEventEmitter/issues))\r\n\r\n    * 2013-06-08 for 0.9.3beta - corrected 'impulse-reading'. Added new impulse-spike, impulse-correction, impulse-warning events. updated package.json version deps.\r\n \r\n    * 2013-06-08 for 0.9.4beta  - corrected history interleave problem. \r\n\r\n    * 2013-05-30 0.9.0beta - initial upload to github @0.9.0\r\n    * 2013-06-05 0.9.1beta - added impulse spike behaviour and coping policy @0.9.1\r\n    * 2013-06-06 0.9.2beta - corrections\r\n    * 2013-06-08 0.9.3beta - impulse-reading correction, refactored to fully evaluate msg before emitting events - this seperated history tag leakage.\r\n    * 2013-06-09 0.9.4beta - impulse bug fixes\r\n    * 2013-06-11 0.9.5beta - bugfixes in impulse and spikes.\r\n    * 2013-06-12 0.9.6beta - 'averages' events added for cummulative consumption information (impulse counters only) , \r\n                           events are issued hourly * 24, daily * 7, weekly * 1 and then recycled. \r\n    * 2013-06-12 0.9.7beta - better support for cc128 xml 'timestamp' support, now outputs a proper 'date/time' object when useOSTime=false. \r\n                           An attempt is made to work out the most appropriate 'date' to wrap around the 'time'\r\n                           Can be manually improved by new 'vdate' parameter to seed an actual 'date' to relate to the time. \r\n    * 2013-06-13 0.9.8beta - 'file:' moniker added to support 'cc128 xml files' within 'device' parameter ('file:/var/log/currentcost/cc128.xml' [absolute] or 'file:mydata/cc128.xml' [relative] ), \r\n                           to allow streaming from source xml files, should use useOSTime=false in these situations \r\n                           in order to make use of the xml files 'time' system in calculations, as events happen in 'faster than realtime'. \r\n    * 2013-06-15 0.9.9beta - 'inpulse-xxxx' events now supply the 'pseudo' channel '1' (should be a non breaking change for people using these events).\r\n                           - 'averaging' events now include normal sensors (within channels). i.e use the 'channel' property to delineate.\r\n                           - 'sensor' events now emit data for 'all' channels, whereas previously only the last channel encountered was used.(technically a bugfix!!)\r\n\r\n\r\n##Overview\r\n\r\nConnects the CurrentCost (EnvIR) basestation (CC128) XML output with node.js EventEmitter.\r\n\r\nI wanted to be able to deal with my EnvIR basestation XML output within node, but \r\nusing node's EventEmitter rather than having to deal with the XML directly. As the EnvIR mostly conforms \r\nto the CC128 specification, this should work with other devices (like the original CC128), so if you use this on \r\nanother device successfully please drop me a line (or [update the github wiki](https://github.com/TheDistractor/CCXMLEventEmitter/wiki/Devices-Checked) ) with the device name/type and if \r\npossible the 'src' property from the 'base' message.\r\n\r\nThere are a few node/currentcost implementations out there, but they did not seem as simple\r\nto interface with as I had envisaged. I'll list some I looked at below as they may be a better fit for others.\r\n\r\nThis module is initialised with a 'device' parameter representing the serial port  \r\nyour currentcost basestation is connected to, or a filesystem file (if the latter, prepend 'file:' to the device parameter, as in 'file:/yourfile.xml'). \r\nAdditional options can be provided as a second hash set.\r\n\r\nOnce you have instantiated an instance of 'CurrentCost128XMLBaseStation' it will emit various messages with relevant \r\ndata that your implementation can listen to and act upon. I will add history events shortly (as I have no current use for them).\r\n\r\nI use coffee-script, so examples are coffee-script\r\n\r\n    ccSvc = require 'cc128EventSvc'\r\n\r\n    options = {emitBaseEvery: 60} #default\r\n\r\n    envir = new ccSvc.CurrentCost128XMLBaseStation '/dev/ttyUSB0', options  #or whatever your usb device is.\r\n\r\n    #you can then listen to those events you want\r\n    envir.on 'sensor', (eventinfo) ->\r\n      console.log \"whole house using:#{eventinfo.watts} watts\" if eventinfo.sensor == 0   \r\n\r\n\r\nYou can also use the module to process an existing xml source file\r\n\r\n    ccSvc = require 'cc128EventSvc'\r\n\r\n    options = {emitBaseEvery: 60} #default\r\n\r\n    envir = new ccSvc.CurrentCost128XMLBaseStation 'file:~/mycurrentcostdata.xml', options  #or whereever your file resides.\r\n\r\n    #you can then listen to those events you want\r\n    envir.on 'sensor', (eventinfo) ->\r\n      console.log \"whole house using:#{eventinfo.watts} watts\" if eventinfo.sensor == 0 \r\n\r\n\r\n*See the examples folder for more information*\r\n\r\nInformation on {options} will be expanded shortly:\r\n\r\n  * device         - default: undefined - path to serial port or a filesystem entry.\r\n    (e.g '/dev/ttyUSB0' or 'file:~/myccfile.xml' ) \r\n  * useOSTime      - default: false     - do we use the O/S time or emit the base stations 'string' time (which drifts)\r\n  * emitBaseEvery  - default: 60        - how often to emit the base message (contains temperature, days-since-birth, firmware rev etc)\r\n  * spikeThreshold - default: 0         - the number of Impulses in a single event to treat as a 'spike' and flatten with an 'average', 0 disables detection.\r\n  * reading        - default: {}        - hash of readings e.g. {'9':1000 #optismart on meter, '5':2300 #solar pv}\r\n  * debug          - default: false     - NB: We also make use of debug=interger\r\n  * logfile        - default: null      - filename to log input data. This now only set automatically if debug=true and logfile is undefined, pass your own filename here to capture input data.\r\n  * vdate          - default: null      - our virtual date/time for filesystem based events, if you have a large input file created 15 days ago, you would use now-15 to seed a date for events.\r\n  * emitAverages   - default: true      - do we emit cummulative average data.\r\n\r\n\r\n#Note:\r\nThe newly added feature to process existing captured current cost xml output (via 'file:' device) allows the (re)processing of this data into the events generated as if the device\r\nhas been connect for the duration. The side effect is that events are generated rather faster than 'real-time', however the event data does capture the correct 'times' of the events, and \r\nif the correct 'vdate' parameter is chosen, the dates will follow the data patterns, and also produce averaging data for these past events.\r\n\r\nI have run some large captures on my raspberry pi, and whilst I am happy with the features and benefits be aware that it does \r\nimpact the little devices' performance, as the pi is rather disk i/o constrained. I can see a few ways to 'lighten' the load, but would\r\nall impact the duration of the run. I'll post a 'largish' test file shortly.\r\n\r\n\r\nThe following events are emitted (descriptions below):\r\n * 'base', (baseinfo)\r\n * 'sensor', (sensorinfo)\r\n * 'impulse', (impulseinfo)\r\n * 'impulse-reading', (impulsereadinginfo)\r\n * 'impulse-avg', (impulseavginfo)\r\n * 'impulse-spike', (impulsespikeinfo)^\r\n * 'impulse-correction', (impulsecorrectioninfo)^\r\n * 'impulse-warning', (impulsewarninginfo)^ \r\n * 'average', (averageinfo)^^\r\n\r\n nb: ^ = new for 0.9.3beta\r\n     ^^ = new for 0.9.8beta\r\n\r\nThe following events are planned:\r\n * 'history', (historyinfo)\r\n\r\n\r\n\r\n###base###\r\n'base' events are generated every {emitBaseEvery} seconds (default = 60). They contain information relating\r\nto the basestation itself. Internally these messages are generated very frequently but they contain very little useful \r\ninformation except perhaps temperature of the base station itself, and are hence reported every 60 seconds by \r\ndefault. This can be changed by the {emitBaseEvery} parameter.\r\n\r\nparameters: baseinfo\r\n\r\n\r\n###sensor###\r\nThis is emitted every time a normal sensor reading is generated, sensors are 0-9 with 0 normally being 'Whole house' \r\nand 9 normally being a 'data' channel. If a 'data' channel is detected, it is actually generated as a set of\r\n'impulse' events as they carry additional information, in which case a 'sensor' event will NOT be generated. \r\n\r\nparameters: sensorinfo\r\n              \r\n\r\n###impulse\r\nThis event is emitted everytime a 'data' channel is encountered. So if you have configured one of your EnvIR \r\nchannels as a 'data' channel it will be reported as 'impulse' rather than 'sensor', as impulse events have \r\nadditional information.\r\n\r\nparameters: impilseinfo\r\n\r\n###impulse-reading###\r\nThis event represents the 'reading' that would be present on your meter dials if you initialised the class with your \r\ncurrent meter reading. It should track your meter within a reasonable margin of error. These events seem to be \r\ngenerated less often than 'sensor' events, approx every 27.5 seconds on my unit.\r\n\r\nparameters: impulsereadinginfo\r\n\r\n###impulse-avg###\r\nThis event represents the average consumption of (elec/gas/water) during the reporting periods. As the period is \r\nless often than 'sensor' events it may not seem to 'follow' your use pattern, but as it is based on 'pulses' it should \r\nbe more accurate than those reported by 'sensor' events for overall consumption reporting.\r\n\r\nparameters: impulseavginfo\r\n\r\n###impulse-spike###\r\nSometimes your impulse sensor (optismart etc) can produce 'false' impulses that I like to call 'spikes', this maybe due to\r\nother IR interference, sensor movement due to environmental conditions, bright glare from sun etc etc.\r\nYou can now use the option: spikeThreshold = ipu to setup 'spike' detection.\r\ne.g spikeThreshold = 60 would set anything above 60 ipu's per detection period to be treated as a spike, in which case a simple\r\naveraging algorithm is used to 'flatten' out the spike reading. A 'flattening' condition is known as a 'correction', in which case\r\na further 'impulse-correction' event will be generated - see below.\r\nBy default, spikes are NOT detected/reported/flattened (equivalent to spikeThreshold = 0).\r\n\r\n\r\nparameters: impulsespikeinfo\r\n\r\n###impulse-correction###\r\nOccurs when a 'spike' event has been 'flattened'.\r\n\r\nparameters: impulsecorrectioninfo\r\n\r\n###impulse-warning###\r\nOccurs when a 'flattening' condition could not be made.\r\n\r\nparameters: impulsewarninginfo\r\n\r\n###average###\r\nThis event is generated when the engine is able to produce averaging data. \r\nIf enabled, events for each sensor/channel are produced hourly * 24, Daily * 7 and weekly * 1.\r\nSo, assuming that some data has been seen for sensor '0' during 16:00-16:59:59 hrs, we will get an hourly average event\r\nproduced at the point the engine sees the hour cycle to 17:00 (whhich is only when the next event record is processed).\r\nThis is generally very soon after the cycle period (within say 5 seconds), but could be longer.\r\nNB: if you are replaying history via an input file, the averages will be emitted within the 'pseduo-clock' that exists within the datastream, \r\nbut again only when the next record causes the detection of a cycle event.\r\n\r\n\r\nparameters: averageinfo\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n##WIKI\r\n[module wiki](https://github.com/TheDistractor/CCXMLEventEmitter/wiki)\r\n\r\n\r\n##Additional implementations of current cost processors I have seen##\r\n* https://github.com/robrighter/node-currentcost\r\n\r\nEmits JSON data representing the underlying XML source message. \r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}